<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Soundboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for active button press effect */
        .sound-btn {
            transition: transform 0.1s ease, filter 0.1s ease, box-shadow 0.1s ease, border 0.1s ease;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            border: 2px solid transparent;
        }
        .sound-btn:active:not(.edit-mode) {
            transform: translateY(4px);
            box-shadow: 0 0px 0 rgba(0,0,0,0.3);
            filter: brightness(1.2);
        }
        /* Active playing state */
        .sound-btn.playing {
            transform: translateY(4px);
            box-shadow: 0 0px 0 rgba(0,0,0,0.3), inset 0 0 15px rgba(0,0,0,0.3);
            filter: brightness(1.2);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        .edit-mode-btn {
            animation: jiggle 0.3s ease-in-out infinite alternate;
        }
        @keyframes jiggle {
            0% { transform: rotate(-1deg); }
            100% { transform: rotate(1deg); }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen font-sans">

    <!-- Header Section -->
    <header class="bg-slate-800 border-b border-slate-700 p-4 sticky top-0 z-10 shadow-md">
        <div class="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-500 p-2 rounded-lg shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                </div>
                <!-- Editable Title UI -->
                <div id="titleDisplayContainer" class="flex items-center gap-2 cursor-pointer group" title="Click to rename">
                    <h1 id="boardTitle" class="text-2xl font-bold tracking-tight truncate max-w-[150px] sm:max-w-xs">Custom Soundboard</h1>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                    </svg>
                </div>
                <input type="text" id="titleInput" class="hidden text-2xl font-bold tracking-tight bg-slate-800 border-b-2 border-indigo-500 focus:outline-none text-white px-1 w-[180px] sm:w-64" value="Custom Soundboard" maxlength="30">
            </div>
            
            <div class="flex items-center gap-2 flex-wrap justify-center">
                <!-- Data Management (Export/Import) -->
                <button id="exportBtn" class="p-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition-colors" title="Backup / Export Board">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </button>
                <label class="p-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition-colors cursor-pointer" title="Restore / Import Board">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    <input type="file" id="importFileInput" accept=".json" class="hidden">
                </label>
                
                <div class="w-px h-6 bg-slate-600 mx-1 hidden sm:block"></div>

                <!-- App Controls -->
                <button id="toggleEditBtn" class="px-3 py-2 rounded-lg font-medium bg-slate-700 hover:bg-slate-600 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                    <span id="editBtnText" class="hidden sm:inline">Edit</span>
                </button>
                <button id="openModalBtn" class="px-3 py-2 rounded-lg font-medium bg-indigo-600 hover:bg-indigo-500 transition-colors shadow-lg flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span>Add <span class="hidden sm:inline">Sound</span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Board -->
    <main class="max-w-6xl mx-auto p-6">
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-slate-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
            <p class="text-xl font-medium mb-2">Your soundboard is empty!</p>
            <p class="text-center">Click "Add Sound" to upload your first audio file,<br>or use the upload icon to import an existing board.</p>
        </div>

        <div id="soundGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            <!-- Sound buttons will be dynamically injected here -->
        </div>
    </main>

    <!-- Add Sound Modal -->
    <div id="addModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md overflow-hidden transform transition-all">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                <h2 class="text-xl font-bold text-white">Add New Sound</h2>
                <button id="closeModalBtn" class="text-slate-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <form id="addSoundForm" class="p-6 space-y-5">
                <!-- Label Input -->
                <div>
                    <label for="soundLabel" class="block text-sm font-medium text-slate-300 mb-1">Button Label</label>
                    <input type="text" id="soundLabel" required placeholder="e.g., Airhorn, Ba Dum Tss" 
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent placeholder-slate-500">
                </div>

                <!-- Color Picker -->
                <div>
                    <label for="soundColor" class="block text-sm font-medium text-slate-300 mb-1">Button Color</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="soundColor" value="#4f46e5" class="h-10 w-20 rounded cursor-pointer bg-slate-900 border border-slate-600 p-1">
                        <span class="text-sm text-slate-400">Pick a background color</span>
                    </div>
                </div>

                <!-- File Upload -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Audio File</label>
                    <label id="dropZone" for="audioFile" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-600 border-dashed rounded-lg hover:border-indigo-500 transition-colors bg-slate-900/50 relative cursor-pointer group">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-slate-400 group-hover:text-indigo-400 transition-colors" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-slate-400 justify-center">
                                <span class="relative rounded-md font-medium text-indigo-400 group-hover:text-indigo-300 focus-within:outline-none">
                                    Upload a file
                                    <input id="audioFile" name="audioFile" type="file" accept="audio/*" class="sr-only" required>
                                </span>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-slate-500">MP3, WAV, OGG up to 10MB</p>
                        </div>
                    </label>
                    <p id="fileNameDisplay" class="mt-2 text-sm text-indigo-400 font-medium hidden truncate"></p>
                </div>

                <!-- Actions -->
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" id="cancelBtn" class="px-4 py-2 rounded-lg font-medium bg-slate-700 hover:bg-slate-600 transition-colors text-white">
                        Cancel
                    </button>
                    <button type="submit" id="saveBtn" class="px-4 py-2 rounded-lg font-medium bg-indigo-600 hover:bg-indigo-500 transition-colors text-white shadow-lg flex items-center gap-2">
                        Save Sound
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-sm overflow-hidden transform transition-all p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-500/10 mb-4">
                <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Delete Sound?</h3>
            <p class="text-sm text-slate-400 mb-6">Are you sure you want to remove this sound? You can't undo this action.</p>
            <div class="flex justify-center gap-3">
                <button id="cancelDeleteBtn" class="px-4 py-2 rounded-lg font-medium bg-slate-700 hover:bg-slate-600 transition-colors text-white w-full">
                    Cancel
                </button>
                <button id="confirmDeleteBtn" class="px-4 py-2 rounded-lg font-medium bg-red-600 hover:bg-red-500 transition-colors text-white w-full">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Full Screen Loading Overlay (For Import/Export) -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm z-[60] hidden flex flex-col items-center justify-center">
        <svg class="animate-spin h-12 w-12 text-indigo-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <h3 id="loadingText" class="text-xl font-bold text-white">Processing...</h3>
        <p class="text-sm text-slate-400 mt-2">This may take a moment.</p>
    </div>

    <!-- Error/Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[70] flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span id="toastMsg">Notification message</span>
    </div>

    <script>
        // --- Constants & State ---
        const DB_NAME = 'SoundboardDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'audioStore';
        const TITLE_KEY = 'soundboard_title';
        
        let db;                     
        let sounds = [];            
        let isEditMode = false;     
        let audioCache = {};        
        let currentTitle = "Custom Soundboard";
        let soundToDeleteId = null; 

        // Playback State Management
        let currentAudio = null;
        let currentPlayingId = null;
        let currentPlayingButton = null;

        // --- DOM Elements ---
        const grid = document.getElementById('soundGrid');
        const emptyState = document.getElementById('emptyState');
        const addModal = document.getElementById('addModal');
        const addSoundForm = document.getElementById('addSoundForm');
        const audioFileInput = document.getElementById('audioFile');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const toggleEditBtn = document.getElementById('toggleEditBtn');
        const editBtnText = document.getElementById('editBtnText');
        const saveBtn = document.getElementById('saveBtn');
        
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMsg');
        const dropZone = document.getElementById('dropZone');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        
        const titleDisplayContainer = document.getElementById('titleDisplayContainer');
        const boardTitle = document.getElementById('boardTitle');
        const titleInput = document.getElementById('titleInput');

        const deleteModal = document.getElementById('deleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        const exportBtn = document.getElementById('exportBtn');
        const importFileInput = document.getElementById('importFileInput');

        // --- 1. IndexedDB Setup (Audio Storage) ---
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve();
                };
                
                request.onerror = (e) => {
                    console.error("IndexedDB error:", e.target.error);
                    showToast("Failed to initialize storage.");
                    reject(e.target.error);
                };
            });
        };

        const saveAudioToDB = (id, blob) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(blob, id);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        };

        const getAudioFromDB = (id) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        };

        const deleteAudioFromDB = (id) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        };

        const clearAudioDB = () => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        };

        // --- 2. LocalStorage Setup (Metadata) ---
        const loadConfig = () => {
            const savedSounds = localStorage.getItem('soundboard_config');
            if (savedSounds) {
                try {
                    sounds = JSON.parse(savedSounds);
                } catch (e) {
                    sounds = [];
                }
            }

            const savedTitle = localStorage.getItem(TITLE_KEY);
            if (savedTitle) {
                currentTitle = savedTitle;
                boardTitle.textContent = currentTitle;
                titleInput.value = currentTitle;
            }
        };

        const saveConfig = () => {
            localStorage.setItem('soundboard_config', JSON.stringify(sounds));
        };

        // --- 3. UI logic & Rendering ---
        const renderBoard = () => {
            grid.innerHTML = ''; // Clear board
            
            if (sounds.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }

            sounds.forEach(sound => {
                const btn = document.createElement('button');
                btn.className = `sound-btn relative flex items-center justify-center p-4 rounded-2xl w-full aspect-square md:aspect-auto md:h-32 text-center text-white font-bold text-lg md:text-xl overflow-hidden group select-none ${isEditMode ? 'edit-mode-btn edit-mode' : ''}`;
                btn.style.backgroundColor = sound.color;
                
                // Keep playing state if re-rendering while a sound is playing
                if (sound.id === currentPlayingId) {
                    btn.classList.add('playing');
                    currentPlayingButton = btn;
                }

                const labelSpan = document.createElement('span');
                labelSpan.textContent = sound.label;
                labelSpan.style.textShadow = '0 2px 4px rgba(0,0,0,0.5)';
                labelSpan.className = 'relative z-10 break-words max-w-full leading-tight pointer-events-none';
                btn.appendChild(labelSpan);

                if (isEditMode) {
                    const deleteOverlay = document.createElement('div');
                    deleteOverlay.className = 'absolute inset-0 bg-red-600/80 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-20 cursor-pointer';
                    deleteOverlay.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    `;
                    btn.appendChild(deleteOverlay);
                }

                btn.addEventListener('click', (e) => {
                    if (isEditMode) {
                        requestDeleteSound(sound.id);
                    } else {
                        playSound(sound.id, btn);
                    }
                });

                btn.addEventListener('touchstart', (e) => {
                    if(!isEditMode) e.preventDefault(); 
                    if(!isEditMode) playSound(sound.id, btn);
                });

                grid.appendChild(btn);
            });
        };

        const toggleEditMode = () => {
            isEditMode = !isEditMode;
            if (isEditMode) {
                toggleEditBtn.classList.replace('bg-slate-700', 'bg-red-600');
                toggleEditBtn.classList.replace('hover:bg-slate-600', 'hover:bg-red-500');
                editBtnText.textContent = "Done";
            } else {
                toggleEditBtn.classList.replace('bg-red-600', 'bg-slate-700');
                toggleEditBtn.classList.replace('hover:bg-red-500', 'hover:bg-slate-600');
                editBtnText.textContent = "Edit";
            }
            renderBoard();
        };

        // --- 4. Title & Core Logic ---
        
        const enableTitleEdit = () => {
            titleDisplayContainer.classList.add('hidden');
            titleInput.classList.remove('hidden');
            titleInput.focus();
            titleInput.select();
        };

        const saveTitleEdit = () => {
            const newTitle = titleInput.value.trim() || "Custom Soundboard";
            currentTitle = newTitle;
            boardTitle.textContent = currentTitle;
            titleInput.value = currentTitle;
            localStorage.setItem(TITLE_KEY, currentTitle);
            
            titleInput.classList.add('hidden');
            titleDisplayContainer.classList.remove('hidden');
        };

        titleDisplayContainer.addEventListener('click', enableTitleEdit);
        titleInput.addEventListener('blur', saveTitleEdit);
        titleInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') titleInput.blur();
            if (e.key === 'Escape') {
                titleInput.value = currentTitle; 
                titleInput.blur();
            }
        });

        const addNewSound = async (e) => {
            e.preventDefault();
            const label = document.getElementById('soundLabel').value.trim();
            const color = document.getElementById('soundColor').value;
            const file = audioFileInput.files[0];

            if (!file) {
                showToast("Please select an audio file.");
                return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg> Saving...`;

            try {
                const uniqueId = 'sound_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                await saveAudioToDB(uniqueId, file);
                sounds.push({ id: uniqueId, label: label, color: color });
                saveConfig();
                
                closeModal();
                renderBoard();
                showToast("Sound added!");
            } catch (err) {
                console.error("Error saving sound:", err);
                showToast("Failed to save. Storage might be full.");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Sound';
            }
        };

        const stopCurrentAudio = () => {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            if (currentPlayingButton) {
                currentPlayingButton.classList.remove('playing');
            }
            currentPlayingId = null;
            currentPlayingButton = null;
            currentAudio = null;
        };

        const playSound = async (id, buttonEl) => {
            try {
                // If clicking the currently playing sound, stop it and return
                if (currentPlayingId === id && currentAudio && !currentAudio.paused) {
                    stopCurrentAudio();
                    return; 
                }

                // If another sound is currently playing, stop it first
                stopCurrentAudio();

                let audioUrl = audioCache[id];

                if (!audioUrl) {
                    const blob = await getAudioFromDB(id);
                    if (!blob) {
                        showToast("Audio missing. Try re-uploading.");
                        return;
                    }
                    audioUrl = URL.createObjectURL(blob);
                    audioCache[id] = audioUrl; 
                }

                // Setup new audio instance
                currentAudio = new Audio(audioUrl);
                currentPlayingId = id;
                currentPlayingButton = buttonEl;
                
                // Add visual state
                buttonEl.classList.add('playing');

                // Clean up visual state when sound naturally ends
                currentAudio.onended = () => {
                    if (currentPlayingId === id) { // Double check we haven't switched sounds
                        buttonEl.classList.remove('playing');
                        currentPlayingId = null;
                        currentPlayingButton = null;
                    }
                };

                currentAudio.play().catch(e => {
                    console.error("Playback failed:", e);
                    showToast("Playback blocked by browser.");
                    stopCurrentAudio();
                });
            } catch (err) {
                console.error("Error playing sound:", err);
                stopCurrentAudio();
            }
        };

        const requestDeleteSound = (id) => {
            soundToDeleteId = id;
            deleteModal.classList.remove('hidden');
        };

        const closeDeleteModal = () => {
            soundToDeleteId = null;
            deleteModal.classList.add('hidden');
        };

        const executeDeleteSound = async () => {
            if (!soundToDeleteId) return;
            const id = soundToDeleteId;
            closeDeleteModal();

            // Stop if deleting the currently playing sound
            if (currentPlayingId === id) {
                stopCurrentAudio();
            }

            sounds = sounds.filter(s => s.id !== id);
            saveConfig();

            try {
                await deleteAudioFromDB(id);
                if (audioCache[id]) {
                    URL.revokeObjectURL(audioCache[id]);
                    delete audioCache[id];
                }
            } catch (err) {
                console.error("Error deleting from DB:", err);
            }

            renderBoard();
        };

        // --- 5. Export / Import Logic ---
        const blobToBase64 = (blob) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        };

        const showLoading = (text) => {
            loadingText.textContent = text;
            loadingOverlay.classList.remove('hidden');
        };

        const hideLoading = () => {
            loadingOverlay.classList.add('hidden');
        };

        const exportBoard = async () => {
            if (sounds.length === 0) {
                showToast("The board is empty!");
                return;
            }

            try {
                showLoading("Packaging soundboard...");
                
                const exportData = {
                    version: 1,
                    title: currentTitle,
                    sounds: []
                };

                // Convert all sounds to Base64
                for (const sound of sounds) {
                    const blob = await getAudioFromDB(sound.id);
                    if (blob) {
                        const base64 = await blobToBase64(blob);
                        exportData.sounds.push({
                            id: sound.id,
                            label: sound.label,
                            color: sound.color,
                            audioData: base64
                        });
                    }
                }

                const jsonString = JSON.stringify(exportData);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                const safeName = currentTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                a.download = `${safeName || 'soundboard'}_backup.json`;
                
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);

                showToast("Export successful!");
            } catch (err) {
                console.error("Export failed:", err);
                showToast("Failed to export soundboard.");
            } finally {
                hideLoading();
            }
        };

        const importBoard = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!confirm("Importing a backup will erase your current soundboard. Are you sure you want to proceed?")) {
                e.target.value = ''; 
                return;
            }

            try {
                showLoading("Extracting audio files...");
                stopCurrentAudio(); // Stop any playback before destroying data

                const text = await file.text();
                const data = JSON.parse(text);

                if (!data || data.version !== 1 || !Array.isArray(data.sounds)) {
                    throw new Error("Invalid format");
                }

                // Clean Slate
                await clearAudioDB();
                sounds = [];
                for (const key in audioCache) {
                    URL.revokeObjectURL(audioCache[key]);
                }
                audioCache = {};

                // Restore Title
                currentTitle = data.title || "Custom Soundboard";
                boardTitle.textContent = currentTitle;
                titleInput.value = currentTitle;
                localStorage.setItem(TITLE_KEY, currentTitle);

                // Restore Audio and Data
                for (const sound of data.sounds) {
                    if (sound.audioData) {
                        // Convert base64 back to Blob
                        const response = await fetch(sound.audioData);
                        const blob = await response.blob();
                        await saveAudioToDB(sound.id, blob);
                        
                        sounds.push({
                            id: sound.id,
                            label: sound.label,
                            color: sound.color
                        });
                    }
                }

                saveConfig();
                renderBoard();
                showToast("Import successful!");

            } catch (err) {
                console.error("Import failed:", err);
                showToast("Failed to import. The file might be corrupted or incompatible.");
            } finally {
                e.target.value = ''; // Reset input
                hideLoading();
            }
        };


        // --- 6. Utilities & Event Listeners ---
        const openModal = () => {
            addSoundForm.reset();
            fileNameDisplay.classList.add('hidden');
            fileNameDisplay.textContent = '';
            addModal.classList.remove('hidden');
        };

        const closeModal = () => {
            addModal.classList.add('hidden');
        };

        const showToast = (message) => {
            toastMsg.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        };

        const handleFileSelect = (file) => {
            if (file) {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                audioFileInput.files = dataTransfer.files;
                
                fileNameDisplay.textContent = `Selected: ${file.name}`;
                fileNameDisplay.classList.remove('hidden');
            } else {
                fileNameDisplay.classList.add('hidden');
            }
        };

        // Bindings
        document.getElementById('openModalBtn').addEventListener('click', openModal);
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        toggleEditBtn.addEventListener('click', toggleEditMode);
        addSoundForm.addEventListener('submit', addNewSound);
        
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        confirmDeleteBtn.addEventListener('click', executeDeleteSound);

        exportBtn.addEventListener('click', exportBoard);
        importFileInput.addEventListener('change', importBoard);

        audioFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));

        addModal.addEventListener('click', (e) => { if (e.target === addModal) closeModal(); });
        deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) closeDeleteModal(); });

        // Drag and Drop Logic
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('border-indigo-500', 'bg-slate-800'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('border-indigo-500', 'bg-slate-800'), false);
        });

        dropZone.addEventListener('drop', (e) => {
            if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
        }, false);

        // --- Initialize App ---
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                loadConfig();
                renderBoard();
            } catch (err) {
                document.body.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center text-center p-6 bg-slate-900 text-white">
                        <div>
                            <h1 class="text-3xl font-bold mb-4 text-red-500">Storage Error</h1>
                            <p>This browser doesn't support local database storage or it is disabled (like in Private/Incognito modes in some browsers).<br>The soundboard cannot run.</p>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</bo